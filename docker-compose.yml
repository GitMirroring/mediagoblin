
version: '3'

services:
  paste:
    build:
      context: .
      dockerfile: Dockerfile-debian-12-sqlite
      args:
        build_doc: no
        run_tests: no
    restart: unless-stopped
    depends_on:
      - rabbitmq
    volumes:
      - ./data:/srv
    ports:
      - "6543:6543"
    env_file: docker-compose.env
    environment:
      - 'CELERY_ALWAYS_EAGER=false'
      - 'BROKER_URL=amqp://rabbitmq:5672'

    # XXX need host = 0.0.0.0 for server:main, or a way to select
    # server-name=broadcast
    # command: /opt/mediagoblin/venv/bin/gmg -cf /srv/mediagoblin.ini serve /srv/paste.ini
    command: /opt/mediagoblin/venv/bin/paster serve /srv/paste.ini --server-name=broadcast
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6543" ]

  celery:
    build:
      context: .
      args:
        build_doc: no
        run_tests: no
    restart: unless-stopped
    depends_on:
      - rabbitmq
      - paster  # let paster start first to migrate the data
    volumes:
      - ./data:/srv
    # ports:
    #   # XXX: avoid collision with paste's EXPOSE from Dockerfile
    #   - "6544:6543"
    env_file: docker-compose.env
    environment:
      - 'CELERY_CONFIG_MODULE=mediagoblin.init.celery.from_celery'
      - 'MEDIAGOBLIN_CONFIG=/srv/mediagoblin.ini'
      - 'SKIP_MIGRATE=true'
      - 'BROKER_URL=amqp://rabbitmq:5672'
    # command: /opt/mediagoblin/venv/bin/gmg -cf /srv/mediagoblin.ini celery
    command: /opt/mediagoblin/venv/bin/celery worker
    healthcheck:
      test: [ "CMD", "/opt/mediagoblin/venv/bin/celery", "inspect", "ping" ]

  rabbitmq:
    image: rabbitmq
    expose:
      - "5672"
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
